---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import LinkButton from "@components/LinkButton.astro";
import Hr from "@components/Hr.astro";
import Socials from "@components/Socials.astro";
import DoiPaperFeed from "@components/DoiPaperFeed.astro";
import { SITE, SOCIALS } from "@config";
import "../styles/home.css";

// Get projects
const projects = await getCollection("projects");
const featuredProjects = projects
  .filter(project => project.data.featured)
  .sort((a, b) => new Date(b.data.startDate).valueOf() - new Date(a.data.startDate).valueOf())
  .slice(0, 3);

// Get team members
const teamMembers = await getCollection("team");

// Define role hierarchy for sorting, matching Team.astro
const roleOrder = [
  "Lab Director",
  "PhD Candidate",
  "Professor",
  "Associate Professor",
  "Assistant Professor", 
  "PhD Student", 
  "Graduate Student", 
  "Master's Student",
  "Undergraduate Student", 
  "Alumni",
  "Collaborator"
];

// Sort team members by role priority and then by name
const sortedTeamMembers = teamMembers
  .filter(member => member.data.featured !== false)
  .sort((a, b) => {
    // First sort by role hierarchy
    const aIndex = roleOrder.findIndex(role => a.data.role.includes(role));
    const bIndex = roleOrder.findIndex(role => b.data.role.includes(role));
    
    if (aIndex !== bIndex) {
      // If role isn't in our predefined list, put it at the end
      if (aIndex === -1) return 1;
      if (bIndex === -1) return -1;
      
      return aIndex - bIndex;
    }
    
    // If same role, sort by name
    return a.data.name.localeCompare(b.data.name);
  });

// Get top 6 team members after sorting
const displayTeamMembers = sortedTeamMembers.slice(0, 18);

// Get publications DOIs directly without needing to sort here
// The DoiPaperFeed component will handle sorting by date from the metadata
const publications = await getCollection("publications");
const dois = publications
  .filter(pub => pub.data.doi)
  .slice(0, 10) // Get a few more than we need in case some fail to load
  .map(pub => pub.data.doi);

const socialCount = SOCIALS.filter(social => social.active).length;

// Format date helper
function formatDate(date) {
  if (!date) return "";
  const parsedDate = date instanceof Date ? date : new Date(date);
  if (isNaN(parsedDate.getTime())) return "";
  
  return parsedDate.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short'
  });
}
---

<Layout>
  <Header />
  <main id="main-content" class="cidrl-main">
    <section id="hero" class="cidrl-hero">
      <div class="hero-content">
        <h1>Cornell Interaction Design Research Lab</h1>
        <p class="hero-tagline">
          Advancing the frontiers of human-computer interaction through innovative research and design
        </p>
        <p class="hero-description">
          The Cornell Interaction Design Research Lab (CIDRL) explores the intersection of human behavior, 
          technology, and design to create more intuitive, accessible, and meaningful interactive experiences.
        </p>
        <div class="hero-buttons">
          <a href="/about/" class="primary-button">
            About Us
          </a>
          <a href="/projects/" class="secondary-button">
            View Projects
          </a>
        </div>
      </div>
      <div class="hero-video-container">
        <iframe 
          class="hero-video"
          src="https://www.youtube.com/embed/o52MZ1AHyjA?si=q7sPaSTebT1WbJMS" 
          title="CIDRL Research Overview"
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen>
        </iframe>
      </div>
    </section>

    <Hr />

    <div class="main-with-sidebar-layout">
      <div class="main-content">
        <section id="featured-projects">
          <h2>Featured Research</h2>
          <div class="project-list">
            {
              featuredProjects.map(project => (
                <a href={`/projects/${project.slug}/`} class="project-card">
                  <div class="project-image">
                    {project.data.image ? (
                      <img src={project.data.image.src} alt={project.data.title} />
                    ) : (
                      <div class="project-image-placeholder"></div>
                    )}
                  </div>
                  <div class="project-card-content">
                    <div class="project-status-badge" data-status={project.data.status}>
                      {project.data.status}
                    </div>
                    <h3>{project.data.title}</h3>
                    <p>{project.data.summary}</p>
                  </div>
                </a>
              ))
            }
          </div>
          <div class="section-link">
            <LinkButton href="/projects/">
              All Projects
              <svg xmlns="http://www.w3.org/2000/svg"
                ><path
                  d="m11.293 17.293 1.414 1.414L19.414 12l-6.707-6.707-1.414 1.414L15.586 11H6v2h9.586z"
                ></path>
              </svg>
            </LinkButton>
          </div>
        </section>

        <Hr />

        <section id="team-members">
          <h2>Research Team</h2>
          <div class="team-grid">
            {
              displayTeamMembers.map(member => (
                <a href={`/team/${member.slug}/`} class="team-card">
                  <div class="member-avatar">
                    {member.data.avatar ? (
                      <img 
                        src={member.data.avatar.src} 
                        alt={`Photo of ${member.data.name}`} 
                      />
                    ) : (
                      <div class="avatar-placeholder">
                        {member.data.name.charAt(0)}
                      </div>
                    )}
                  </div>
                  <div class="member-info">
                    <h3>{member.data.name}</h3>
                    <p>{member.data.role}</p>
                  </div>
                </a>
              ))
            }
          </div>
          <div class="section-link">
            <LinkButton href="/team/">
              View Full Team
              <svg xmlns="http://www.w3.org/2000/svg"
                ><path
                  d="m11.293 17.293 1.414 1.414L19.414 12l-6.707-6.707-1.414 1.414L15.586 11H6v2h9.586z"
                ></path>
              </svg>
            </LinkButton>
          </div>
        </section>

        {
          socialCount > 0 && (
            <div class="social-wrapper">
              <div class="social-links">Connect with us:</div>
              <Socials />
            </div>
          )
        }
      </div>

      <div class="sidebar">
        <aside class="publications-sidebar">
          <DoiPaperFeed 
            dois={dois} 
            title="Recent Publications" 
            viewAllUrl="/publications/"
            maxItems={5}
          />
        </aside>
      </div>
    </div>
  </main>

  <Footer />
</Layout>
